---
title:  "AWS EC2이용한 AWS에 배포하기"
author: Gyuhyeon Hwang
date:   2022-07-26 22:06:30 +9
categories: [Setting]
tags: [Docker, AWS]
render_with_liquid: false
# pin: true
---
### AWS에 프로젝트 배포하기!

![전체 폴더 구조](https://hgyuhyeon.github.io/img/38/root.png "전체 폴더 구조")

우선 이것은 나의 프로젝트 파일 구조!

client는 프론트엔드(리액트), 
nginx는 서버 설정 파일,
db는 데이터베이스 설정 파일(스키마 생성만 있음),
server는 백엔드(장고) 파일이다.

![서버 폴더 구조](https://hgyuhyeon.github.io/img/38/server.png "서버 폴더 구조")

서버 폴더 안은 이렇게 이루어져 있고, key.json은 시크릿키랑 api키를 모아두었다.

keywords.csv는 모델 학습할 때 사용하는 파일이다(우리 프로젝트는 모델을 장고 안에 포함시켰다).

우선 도커파일은 /server 에만 작성했다. 모델 설치하면서 필요한 작업이 늘어났기 때문이다.

이외의 컨테이너는 전부 docker-compose.yml로 해결했다.

```Dockerfile
FROM ubuntu:22.04
# EC2의 우분투 버전과 통일(모델 안 사용한다면 python:3.9 이미지로도 충분하다)

RUN apt-get -y update
RUN apt-get install -y python3-pip
RUN pip3 install --upgrade pip
# pip 설치


### 데이터베이스 연결 부분 ###
RUN apt-get install libmysqlclient-dev -y
# for MySQLclient (이거 설치 안되면 mysqlclient 설치 시 오류 발생)


### 모델 연결 부분 ###
RUN apt-get update && apt-get install -y git
RUN pip install git+https://github.com/openai/CLIP.git
RUN pip install ftfy regex tqdm 
# CLIP 모델

RUN pip install torch torchvision
# CNN 모델

RUN pip install spotipy
# spotify api


### 장고 모듈 설치 부분 ###
RUN mkdir /config
ADD /config/requirements.txt /config/
RUN pip3 install --no-cache-dir -r /config/requirements.txt
# requirements.txt 실행

EXPOSE 8000
```

/server/Dockerfile 부분의 도커파일!

```yml
version: '3'

services:
  db:
    image: mysql:8.0.22
    container_name: my01
    command: mysqld --character-set-server=utf8 --collation-server=utf8_general_ci --default-authentication-plugin=mysql_native_password
    ports:
      - "3306:3306"
    volumes:
      - ./db/:/docker-entrypoint-initdb.d/
    environment: 
      MYSQL_ROOT_PASSWORD: "8de"
      MYSQL_DB: "8dedb"
    platform: linux/x86_64
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      interval: 1m30s
      timeout: 30s
      retries: 10
      start_period: 30s

  nginx:
    image: nginx:latest
    container_name: ng01
    ports:
      - "80:8080"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./client/build:/var/www/client
    depends_on: 
      - server
      - client

  client:
    image: node:18
    container_name: re01
    working_dir: /client
    command: bash -c "
        yarn install &&
        yarn build"
    # command: sh entrypoint.sh
    volumes:
      - ./client/:/client
    depends_on:
      - db
  
  server:
    build: 
      context: ./server
      dockerfile: ./Dockerfile #도커파일 이용해서 빌드
    container_name: dg01
    working_dir: /server
    command: bash -c "
        python3 manage.py makemigrations account &&
        python3 manage.py makemigrations playlist &&
        python3 manage.py makemigrations model &&
        python3 manage.py migrate &&
        gunicorn --bind 0.0.0.0:8000 server.wsgi:application -t 240"
    # command: sh entrypoint.sh
    volumes:
      - ./server/:/server
    expose:
      - "8000"
    depends_on:
      db:
        condition: service_healthy
```

docker-compose.yml 파일!

컨테이너는 총 4개로 나누었고, mysql 서버가 늦게 시작하기 때문에 먼저 시작할 수 있도록 healthcheck를 넣었다. [이전 글](https://hgyuhyeon.github.io/posts/28/)을 보면 알 수 있지만, 장고의 migration과 같은 데이터베이스 활용 명령어는 Dockerfile이 아니라 docker-compose에서 command로 실행시켜야 순서에 맞게 실행한다!

[또 다른 이전 글](https://hgyuhyeon.github.io/posts/37/)을 보면, command를 entrypoint.sh로 하지 않은 이유가 나타난다. 혼자 사용하는 프로젝트면 상관없는데, 여럿이 쓰는 프로젝트면 줄바꿈이 너무 귀찮아진다. 특히 윈도우는... 정말 귀찮다.

이런 설정들을 모두 마치면, 이제 aws로 이동한다.

1. aws에서 프리 티어를 이용하여 t2 micro 인스턴스를 생성한다.
  * 만약 기본 VPC가 없으면 스스로 vpc와 subnet을 만들어야 하고, 이 때 퍼블릭 주소를 설정하지 않으면 퍼블릭 주소를 자동으로 할당받지 못한다, [기본 VPC 만들기](https://velog.io/@tlsalsckd13/AWS-%EA%B8%B0%EB%B3%B8-VPC-%EB%A7%8C%EB%93%A4%EA%B8%B0)를 참고해서 생성한다.
  * 인스턴스를 생성할 때 스토리지 설정이 있다.<br/> 
  ![스토리지 설정](https://hgyuhyeon.github.io/img/38/storage.png "스토리지 설정")
  <br/>바로 이것! 사진에서 보이는 8이 현재 ssd 용량이다. 이것을 프리 티어에서 최대로 사용할 수 있는 30으로 변경한다(왜 변경하는지 아래에 이유가 나온다).

2. 배포 과정중에 발생한 오류
  * `command failed with exit code 137`<br/>
  RAM용량이 부족해서 발생하는 오류이다. 나는 AI모델을 가져오면서 발생했었다. 이 오류는 어떻게 수정하지? 우리는 프리 티어에서 벗어나서 굳이 돈을 쓰고 싶지 않았다. 이것저것 찾아보다가 [스왑 메모리](https://sundries-in-myidea.tistory.com/102)를 활용하는 블로그를 찾게 되었다. 블로그에서도 [공식 문서](https://aws.amazon.com/ko/premiumsupport/knowledge-center/ec2-memory-swap-file/)를 소개하고 있으니 두 가지 중에 편한 글을 찾아 보면 된다. 스왑 메모리를 활용해서 RAM의 크기를 늘려줬고, 잘 실행될 수 있었다.
  * `error 28 no space left on device`<br/>
  스토리지 용량이 부족해서 발생하는 오류이다. 위에서 스토리지 설정을 언급한 이유이다. 나는 이 설정을 바꾸어야 인스턴스의 스토리지 용량이 바뀐다는 것을 많은 시간이 지나서야 알았지만... 처음부터 넉넉하게 설정해서 오류가 나지 않도록 하자!

3. 도커 설치는 어떻게?
  * 도커 설치는 [이 블로그]()를 참고했다. 단 이곳은 줄바꿈 문자가 그대로 들어가 있다(백슬래시). 지우고 실행하면 된다. docker-compose도 같은 블로그를 참고했지만, 나는 정상적으로 설치되지 않아서 정상적으로 설치되었던 명령어로 재작성하고자 한다. 

```sh
### Docker ###
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" 

sudo apt update

sudo apt install docker-ce

docker --version


### docker-compose ###
curl -L "https://github.com/docker/compose/releases/download/v2.2.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

sudo chmod +x /usr/local/bin/docker-compose

docker-compose --version
```

이상 내가 docker, docker-compose 설치할 때 사용했던 명령어들이다.

4. docker-compose up 실행
  * `docker-compose up` 을 실행하면 도커 컨테이너가 실행된다.
  * 단, 이것은 터미널을 종료하면 같이 종료되기 때문에 nohup을 이용해서 컨테이너가 계속 실행되도록 한다.
  * `nohup docker-compose up` 과 같이 추가해서 빌드 및 실행하면 웹서비스가 나타난다!

5. 접속 방법?
  * 두 가지 방법으로 접속할 수 있다.
  * 퍼블릭 IPv4주소(12.34.567.890)
  * 퍼블릭 IPv4 DNS(ec2-12-34-567-890.ap-northeast-2.compute.amazonaws.com)
  * 이 둘 중 어떤 방법을 사용해도 된다.
  * 도메인 적용하면 당연히 달라지겠지만, 도메인을 적용하지 않으면 저 둘 중 1개의 url을 활용한다!

이상 나의 AWS EC2 배포과정이었다.
